<!DOCTYPE html>
<html>
  <head>
    <script src="aframe-master.min.js"></script>
    <script src="aframe-network-component.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v3.3.0/dist/aframe-extras.min.js"></script>
    <script>
      AFRAME.registerComponent("look-at", {
        schema: {type: "selector"},
        init: function () {},
        tick: function () {
          this.el.object3D.lookAt(this.data.object3D.position);
        }
      });
    </script>
    <script>
      AFRAME.registerComponent('draggable', {
        init: function () {
          this.el.setAttribute('super-hands', {
            colliderEvent: 'raycaster-intersection',
          });
          this.el.setAttribute('grab-options', {
            colliderEvent: 'raycaster-intersection',
          });
          this.el.addEventListener('grab-start', function (evt) {
            var hand = evt.detail.hand;
            this.setAttribute('data-grabbed-by', hand.id);
          });
          this.el.addEventListener('grab-end', function (evt) {
            this.removeAttribute('data-grabbed-by');
          });
          this.el.addEventListener('drag-move', function (evt) {
            var hand = evt.detail.hand;
            var intersection = evt.detail.intersection;
            var newPosition = intersection.point;
            this.object3D.position.copy(newPosition);
          });
        }
      });
    </script>
  </head>
  <body>
    <audio id="audioOn" src="click_on.wav"></audio>
    <audio id="audioOff" src="click_off.wav"></audio>
    <a-scene background="color: #FFFFFF;">
      <a-entity id="camera" camera look-controls wasd-controls="acceleration: 5;" position="0.0 1.6 0.0"></a-entity>
      <a-entity light="type: ambient;"></a-entity>
      <a-entity id="leftController" hand-controls="hand: left; handModelStyle: highPoly; color: #7F7F7F"></a-entity>
      <a-entity id="rightController" hand-controls="hand: right; handModelStyle: highPoly; color: #7F7F7F"></a-entity>
      <a-entity id="leftHand" hand-tracking-controls="hand: left; modelColor: #7F7F7F;"></a-entity>
      <a-entity id="rightHand" hand-tracking-controls="hand: right; modelColor: #7F7F7F"></a-entity>
      <a-circle position="0.0 0.0 0.0" radius="2.200000" rotation="-90 0 0" color="#F0F0F0"></a-circle>
      <a-network position="0.0 0.0 0.0" rotation="0 0 0" node_size="0.080000" edge_opacity="0.2" src="url(fava_light.ply)">
        <a-entity id="node1" class="draggable" position="-0.684681 0.229279 -2.061385" radius="0.08" material="color: red"></a-entity>
        <a-entity id="node2" class="draggable" position="0.128368 0.226768 2.144488" radius="0.08" material="color:
        <a-network position="0.0 0.0 0.0" rotation="0 0 0" node_size="0.080000" edge_opacity="0.2" src="url(fava_light.ply)" super-hands></a-network>

        <script>
          const node_names = ["BPNT1","RACGAP1"];
          const node_positions = [-0.684681,0.229279,-2.061385,0.128368,0.226768,2.144488];
          
          AFRAME.registerComponent("move-node", {
            schema: {
              index: { type: "number" },
              positions: { type: "array" }
            },
            init: function () {
              this.controller = null;
              this.grabbing = false;
            },
            play: function () {
              const controllerName = this.el.getAttribute("hand-controls").hand;
              this.controller = document.querySelector(`#${controllerName}Controller`);
              this.controller.addEventListener("gripdown", this.startGrab.bind(this));
              this.controller.addEventListener("gripup", this.endGrab.bind(this));
            },
            pause: function () {
              this.controller.removeEventListener("gripdown", this.startGrab.bind(this));
              this.controller.removeEventListener("gripup", this.endGrab.bind(this));
              this.controller = null;
            },
            startGrab: function () {
              this.grabbing = true;
            },
            endGrab: function () {
              this.grabbing = false;
            },
            tick: function () {
              if (this.grabbing) {
                const position = this.controller.getAttribute("position");
                this.data.positions[this.data.index * 3] = position.x;
                this.data.positions[this.data.index * 3 + 1] = position.y;
                this.data.positions[this.data.index * 3 + 2] = position.z;
                this.el.setAttribute("positions", this.data.positions);
              }
            }
          });
        
          AFRAME.registerComponent("move-all-nodes", {
            schema: {
              positions: { type: "array" }
            },
            init: function () {
              this.controller = null;
              this.grabbing = false;
            },
            play: function () {
              const controllerName = this.el.getAttribute("hand-controls").hand;
              this.controller = document.querySelector(`#${controllerName}Controller`);
              this.controller.addEventListener("gripdown", this.startGrab.bind(this));
              this.controller.addEventListener("gripup", this.endGrab.bind(this));
            },
            pause: function () {
              this.controller.removeEventListener("gripdown", this.startGrab.bind(this));
              this.controller.removeEventListener("gripup", this.endGrab.bind(this));
              this.controller = null;
            },
            startGrab: function () {
              this.grabbing = true;
            },
            endGrab: function () {
              this.grabbing = false;
            },
            tick: function () {
              if (this.grabbing) {
                const position = this.controller.getAttribute("position");
                const nodes = this.el.getAttribute("positions");
                for (let i = 0; i < nodes.length; i += 3) {
                  nodes[i] += position.x - this.prevPosition.x;
                  nodes[i + 1] += position.y - this.prevPosition.y;
                  nodes[i + 2] += position.z - this.prevPosition.z;
                }
                this.el.setAttribute("positions", nodes);
                this.prevPosition = position;
              }
            }
          });
        
          const network = document.querySelector("a-network");
          network.addEventListener("network-loaded", () =>
          var network = document.querySelector("a-network");
    var nodes = network.components.network.nodes;
    for (let i = 0; i < nodes.length; i++) {
      let node = nodes[i];
      let position = node.position;
      node.setAttribute("dynamic-body", "shape: sphere; sphereRadius: 0.1; mass: 0.5");
      node.setAttribute("super-hands", "colliderEvent: collisions; colliderEventProperty: els; colliderEndEvent: collisions; colliderEndEventProperty: clearedEls");
      node.addEventListener("grab-start", function (event) {
        this.setAttribute("dynamic-body", "mass: 10");
      });
      node.addEventListener("grab-end", function (event) {
        this.setAttribute("dynamic-body", "mass: 0.5");
      });
    }
  </script>
</body>
</html>